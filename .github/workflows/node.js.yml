# Allow this job to clone the repo and create a page deployment
permissions:
  contents: read
  pages: write
  id-token: write

name: Afrodeals pnpm workflow
on:
  push:
    branches: [ "main", "dev" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    environment: 
      name: ${{ github.ref == 'refs/heads/main' && 'main' || 'dev' }}
      url: ${{ steps.deployment.outputs.page_url }}
    strategy:
      fail-fast: false
      matrix:
        # Using too much GitHub Actions free usage per month...
        # node-version: [14.x, 15.x, 16.x, 17.x, 18.x]
        node-version: [18.x]
        os: [ubuntu-latest]
    steps:
        - name: Checkout your repository using git
          uses: actions/checkout@v4
        - name: Setup environment variables
          env:
            PUBLIC_SNIPCART_API_KEY: ${{ secrets.PUBLIC_SNIPCART_API_KEY }}
          run: |
            cd packages/playground
            touch .env
            echo PUBLIC_SNIPCART_API_KEY="$PUBLIC_SNIPCART_API_KEY" >> .env
        - name: Install, build, and upload your site output
          uses: withastro/action@v2
          with:
              path: ./packages/playground # The root location of your Astro project inside the repository. (optional)
              node-version: 20 # The specific version of Node that should be used to build your site. Defaults to 18. (optional)
              package-manager: pnpm@7 # The Node package manager that should be used to install dependencies and build your site. Automatically detected based on your lockfile. (optional)


  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: github-pages
      url: ${{steps.deployment.outputs.page_url}}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4